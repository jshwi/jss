{# base.html #}
{% extends "bootstrap/base.html" %}

{# override ``page_name`` to display in browser tab #}
{# browser tab will show ``<page_name> - <config["BRAND"]>`` #}
<title>{% block title %}{% block page_name %}{% endblock %} - {{ config["BRAND"] }}{% endblock %}</title>

{% block metas %}
    {{ super() }}

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
{% endblock %}

{# source static files #}
{% block styles %}
    {{ super() }}

    {# checkbox as toggle switch #}
    <link id="bootstrap-toggle"
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css">

    {# icons lib #}
    <link id="bootstrap-icons"
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">

    {# additional style rules #}
    <link id="style" rel="stylesheet" href="{{ static_url_for('static', filename='css/style.css') }}">

    {# syntax-highlighting stylesheet for fenced code blocks #}
    <link id="syntax-style"
          rel="stylesheet"
          href="{{ static_url_for('static', filename='css/highlight/default.css') }}">
{% endblock %}

{# for navigating site #}
{% block navbar %}{{ nav.top.render(renderer="navbar_renderer") }}{% endblock %}

{# override ``Bootstraps`` content  #}
{# all inherited content will be sent to the ``app_content`` block #}
{% block content %}

    {# keep contents within centre of the screen #}
    <div class="container">

        {# tasks progress bar #}
        {{ dom_macros_task_progress() }}

        {# all instruction to flash messages will be handled here #}
        {{ dom_macros_flash_messages() }}

        {# override ``page_name`` to display in the header block #}
        {# declared in the title block #}
        <header><h1>{% block header %}{{ self.page_name() }}{% endblock %}</h1></header>

        {# variable page content to override for each template #}
        {% block app_content %}{% endblock %}

        {# override for pages displaying posts and use as base #}
        {% block posts %}{% endblock %}

        {# display footer on all pages #}
        {% block footer %}{% include "footer.html" %}{% endblock %}
    </div>
{% endblock %}

{# additional JavaScript functionality #}
{% block scripts %}
    {{ super() }}

    {# syntax highlighting for fenced markdown code #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/languages/python.min.js"></script>

    {# apply dark-mode from darkreader: https://darkreader.org/ #}
    {# disabled by default (night-mode off) #}
    <!--suppress HtmlDeprecatedAttribute -->
    <script src="https://cdn.jsdelivr.net/npm/darkreader@4.9.40/darkreader.min.js"></script>

    {# import JavaScript functions #}
    <script src="{{ static_url_for("static", filename="js/main.js") }}"></script>
    <!--suppress JSUnresolvedFunction, JSUnresolvedVariable -->
    <script nonce="{{ csp_nonce() }}">hljs.highlightAll()</script>

    {# checkbox as toggle switch #}
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    {# from https://github.com/miguelgrinberg/Flask-Moment #}
    {# see https://github.com/miguelgrinberg/Flask-Moment/issues/43 #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>

    <!--suppress JSCheckFunctionSignatures -->
    <script nonce="{{ csp_nonce() }}">
        moment.locale("en");
        function flask_moment_render(elem) {
            const timestamp = moment(elem.dataset.timestamp);
            const func = elem.dataset.function;
            const format = elem.dataset.format;
            const timestamp2 = elem.dataset.timestamp2;
            const no_suffix = elem.dataset.nosuffix;
            const units = elem.dataset.units;
            let args = [];
            if (format)
                args.push(format);
            if (timestamp2)
                args.push(moment(timestamp2));
            if (no_suffix)
                args.push(no_suffix);
            if (units)
                args.push(units);
            elem.textContent = timestamp[func].apply(timestamp, args);
            elem.classList.remove('flask-moment');
            elem.style.display = "";
        }
        function flask_moment_render_all() {
            const moments = document.querySelectorAll('.flask-moment');
            moments.forEach(function(moment) {
                flask_moment_render(moment);
                const refresh = moment.dataset.refresh;
                if (refresh && refresh > 0) {
                    (function(elem, interval) {
                        setInterval(function() {
                            flask_moment_render(elem);
                        }, interval);
                    })(moment, refresh);
                }
            })
        }
        document.addEventListener("DOMContentLoaded", flask_moment_render_all);
    </script>

    <!--suppress JSUnresolvedVariable -->
    <script nonce="{{ csp_nonce() }}">
      {% if current_user.is_authenticated %}
        $(function () {
          let since = 0
          setInterval(function () {
            $.ajax("{{ url_for("user.notifications") }}?since" + since).done(
              function (notifications) {
                for (let i = 0; i < notifications.length; i++) {
                  switch (notifications[i].name) {
                    case "unread_message_count":
                      set_message_count(notifications[i].data)
                      break
                    case "task_progress":
                      set_task_progress(
                        notifications[i].data.task_id,
                        notifications[i].data.progress
                      )
                      break
                  }
                  since = notifications[i].timestamp
                }
              }
            )
          }, 10000)
        })
      {% endif %}
    </script>
{% endblock %}
